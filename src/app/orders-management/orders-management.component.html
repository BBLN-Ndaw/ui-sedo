<!-- Navigation breadcrumb -->
<div class="breadcrumb-nav">
  <button 
    mat-button 
    class="nav-link"
    (click)="goBack()">
    <mat-icon>dashboard</mat-icon>
    Dashboard
  </button>
  <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
  <span class="current-page">Gestion des Commandes</span>
</div>

<div class="orders-management-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>assignment</mat-icon>
      Gestion des Commandes
    </h1>
    <p class="page-description">Gérez toutes les commandes des clients</p>
    
    <div class="header-actions">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="refreshOrders()">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="stats-section" *ngIf="!isLoading && totalOrders > 0">
    <mat-card class="stats-card">
      <mat-card-content>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ getTotalOrders() }}</div>
            <div class="stat-label">Commandes filtrées</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getTotalRevenue() | currency:'EUR':'symbol':'1.0-0' }}</div>
            <div class="stat-label">Chiffre d'affaires</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getOrdersByStatus(OrderStatus.PENDING) }}</div>
            <div class="stat-label">En attente</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getOrdersByStatus(OrderStatus.PROCESSING) }}</div>
            <div class="stat-label">En préparation</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filtres -->
  <div class="filters-section" *ngIf="!isLoading && totalOrders > 0">
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-content">
          <!-- Recherche -->
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Rechercher</mat-label>
            <input 
              matInput 
              [formControl]="searchControl"
              placeholder="N° de commande ou nom client">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Filtre par statut -->
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filtrer par statut</mat-label>
            <mat-select [formControl]="statusFilter">
              <mat-option 
                *ngFor="let option of statusOptions" 
                [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Filtre par période -->
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filtrer par période</mat-label>
            <mat-select [formControl]="periodFilter">
              <mat-option 
                *ngFor="let option of periodOptions" 
                [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Bouton de réinitialisation -->
          <button 
            mat-stroked-button 
            (click)="refreshOrders()"
            class="reset-filters-btn">
            <mat-icon>clear</mat-icon>
            Réinitialiser
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-card>
      <mat-card-content>
        <div class="loading-content">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Chargement des commandes...</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tableau des commandes -->
  <div class="orders-table-section" *ngIf="!isLoading && dataSource.data.length > 0">
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list</mat-icon>
          Liste des Commandes ({{ totalOrders }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" class="orders-table">

            <!-- Colonne Numéro de commande -->
            <ng-container matColumnDef="orderNumber">
              <th mat-header-cell *matHeaderCellDef>N° Commande</th>
              <td mat-cell *matCellDef="let order" class="order-number-cell">
                <div class="order-number">
                  <mat-icon>receipt</mat-icon>
                  <span>{{ order.orderNumber || 'N/A' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Client -->
            <ng-container matColumnDef="customerName">
              <th mat-header-cell *matHeaderCellDef>Client</th>
              <td mat-cell *matCellDef="let order" class="customer-cell">
                <div class="customer-info">
                  <mat-icon>person</mat-icon>
                  <span>{{ order.customerName || 'Anonyme' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Date -->
            <ng-container matColumnDef="createdAt">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let order" class="date-cell">
                <div class="order-date">
                  <mat-icon>calendar_today</mat-icon>
                  <div class="date-info">
                    <div class="date">{{ order.createdAt | date:'dd/MM/yyyy' }}</div>
                    <div class="time">{{ order.createdAt | date:'HH:mm' }}</div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Statut -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Statut</th>
              <td mat-cell *matCellDef="let order" class="status-cell">
                <mat-chip 
                  [color]="getStatusColor(order.status)"
                  selected>
                  <mat-icon>{{ getStatusIcon(order.status) }}</mat-icon>
                  {{ getStatusLabel(order.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Colonne Montant -->
            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef>Montant</th>
              <td mat-cell *matCellDef="let order" class="amount-cell">
                <div class="amount">
                  <strong>{{ order.totalAmount | currency:'EUR':'symbol':'1.2-2' }}</strong>
                  <small *ngIf="order.items?.length">{{ order.items.length }} article(s)</small>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let order" class="actions-cell">
                <div class="action-buttons">
                  <!-- Bouton Détails -->
                  <button 
                    mat-icon-button 
                    color="primary"
                    (click)="openOrderDetails(order.id!); $event.stopPropagation()"
                    matTooltip="Voir les détails">
                    <mat-icon>visibility</mat-icon>
                  </button>

                  <!-- Menu Actions -->
                  <button 
                    mat-icon-button 
                    [matMenuTriggerFor]="actionsMenu"
                    (click)="$event.stopPropagation()"
                    matTooltip="Plus d'actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #actionsMenu="matMenu">
                    <button 
                      *ngFor="let option of order | statusOptions"
                      mat-menu-item
                      (click)="$event.stopPropagation(); changeOrderStatus(order.id!, option.status)">
                      <mat-icon>{{ getStatusIcon(option.status) }}</mat-icon>
                      <span>{{ option.label }}</span>
                    </button>
                    
                    <mat-divider *ngIf="(order | statusOptions).length > 0"></mat-divider>
                    
                    <button 
                      mat-menu-item
                      (click)="openOrderDetails(order.id!); $event.stopPropagation()"
                      class="details-action">
                      <mat-icon>info</mat-icon>
                      <span>Détails complets</span>
                    </button>
                  </mat-menu>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr 
              mat-row 
              *matRowDef="let order; columns: displayedColumns;"
              class="order-row"
              (click)="openOrderDetails(order.id!)">
            </tr>
          </table>
        </div>
        
        <!-- Pagination -->
        <mat-paginator 
          #paginator
          [length]="totalOrders"
          [pageSize]="currentPageSize"
          [pageSizeOptions]="[10, 20, 30, 50]"
          [pageIndex]="currentPage"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- État vide -->
  <div class="empty-state" *ngIf="!isLoading && dataSource.data.length === 0">
    <mat-card class="empty-state-card">
      <mat-card-content>
        <div class="empty-state-content">
          <mat-icon class="empty-icon">shopping_bag</mat-icon>
          <h3>{{ getEmptyStateTitle() }}</h3>
          <p>{{ getEmptyStateMessage() }}</p>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="refreshOrders()">
            <mat-icon>refresh</mat-icon>
            Actualiser
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>