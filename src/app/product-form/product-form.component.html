<div class="product-form-container">
  <!-- Navigation breadcrumb -->
  <div class="breadcrumb-nav">
    <button 
      mat-button 
      class="nav-link"
      (click)="goBackToProductsList()">
      <mat-icon>arrow_back</mat-icon>
      Liste des produits
    </button>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <span class="current-page">{{ isEditMode ? 'Modifier le produit' : 'Nouveau produit' }}</span>
  </div>

  <!-- Formulaire principal -->
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="title-icon">{{ isEditMode ? 'edit' : 'add_shopping_cart' }}</mat-icon>
        {{ getFormTitle() }}
      </mat-card-title>
      <mat-card-subtitle *ngIf="isEditMode">
        Modification des informations du produit
      </mat-card-subtitle>
      <mat-card-subtitle *ngIf="!isEditMode">
        Création d'un nouveau produit
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form">
        
        <!-- Informations de base -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>inventory</mat-icon>
            Informations de base
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Nom du produit</mat-label>
              <input matInput formControlName="name">
              <mat-icon matSuffix>label</mat-icon>
              <mat-error *ngIf="isFieldRequired('name')">
                {{ getFieldError('name') }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" 
                        rows="3"></textarea>
              <mat-icon matSuffix>description</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>SKU</mat-label>
              <input matInput formControlName="sku">
              <mat-icon matSuffix>qr_code</mat-icon>
              <mat-error *ngIf="isFieldRequired('sku')">
                {{ getFieldError('sku') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Unité</mat-label>
              <mat-select formControlName="unit">
                <mat-option *ngFor="let unit of availableUnits" [value]="unit">
                  {{ unit }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldRequired('unit')">
                {{ getFieldError('unit') }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Catégorie et fournisseur -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>category</mat-icon>
            Catégorie et fournisseur
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Catégorie</mat-label>
              <mat-select formControlName="categoryId">
                <mat-option value="">-- Sélectionner une catégorie --</mat-option>
                <mat-option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldRequired('categoryId')">
                {{ getFieldError('categoryId') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Fournisseur ID</mat-label>
              <input matInput formControlName="supplierId">
              <mat-icon matSuffix>business</mat-icon>
              <mat-error *ngIf="isFieldRequired('supplierId')">
                {{ getFieldError('supplierId') }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Prix et TVA -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>euro</mat-icon>
            Prix et TVA
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Prix d'achat (HT)</mat-label>
              <input matInput type="number" formControlName="purchasePrice" 
                     step="0.01" min="0">
              <span matSuffix>€</span>
              <mat-error *ngIf="isFieldRequired('purchasePrice')">
                {{ getFieldError('purchasePrice') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Prix de vente (HT)</mat-label>
              <input matInput type="number" formControlName="sellingPrice" 
                     step="0.01" min="0">
              <span matSuffix>€</span>
              <mat-error *ngIf="isFieldRequired('sellingPrice')">
                {{ getFieldError('sellingPrice') }}
              </mat-error>
              <mat-hint *ngIf="productForm.get('sellingPrice')?.value">
                Prix TTC : {{ sellingPriceTTC | currency:'EUR':'symbol':'1.2-2' }}
              </mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Taux de TVA</mat-label>
              <input matInput type="number" formControlName="taxRate" 
                     step="0.01" min="0" max="1">
              <span matSuffix>%</span>
              <mat-error *ngIf="isFieldRequired('taxRate')">
                {{ getFieldError('taxRate') }}
              </mat-error>
              <mat-hint>Ex: 0.20 pour 20%</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Stock -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>inventory_2</mat-icon>
            Gestion du stock
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Quantité en stock</mat-label>
              <input matInput type="number" formControlName="stockQuantity" 
                     min="0">
              <mat-error *ngIf="isFieldRequired('stockQuantity')">
                {{ getFieldError('stockQuantity') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Stock minimum</mat-label>
              <input matInput type="number" formControlName="minStock" 
                     min="0">
              <mat-error *ngIf="isFieldRequired('minStock')">
                {{ getFieldError('minStock') }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" floatLabel="always" class="full-width">
              <mat-label>Date d'expiration</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="expirationDate">
              <mat-hint>Format: JJ/MM/AAAA</mat-hint>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="isFieldRequired('expirationDate')">
                {{ getFieldError('expirationDate') }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Promotion -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>local_offer</mat-icon>
            Promotion
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-checkbox formControlName="isOnPromotion">
              Produit en promotion
            </mat-checkbox>
          </div>

          <div class="form-row" *ngIf="productForm.get('isOnPromotion')?.value">
            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Prix promotionnel (HT)</mat-label>
              <input matInput type="number" formControlName="promotionPrice" 
                     step="0.01" min="0">
              <span matSuffix>€</span>
              <mat-error *ngIf="isFieldRequired('promotionPrice')">
                {{ getFieldError('promotionPrice') }}
              </mat-error>
              <mat-hint *ngIf="productForm.get('promotionPrice')?.value">
                Prix promo TTC : {{ promotionPriceTTC | currency:'EUR':'symbol':'1.2-2' }}
              </mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" floatLabel="always" class="half-width">
              <mat-label>Fin de promotion</mat-label>
              <input matInput [matDatepicker]="promoPicker" formControlName="promotionEndDate">
              <mat-hint>Date de fin de la promotion</mat-hint>
              <mat-datepicker-toggle matSuffix [for]="promoPicker"></mat-datepicker-toggle>
              <mat-datepicker #promoPicker></mat-datepicker>
              <mat-error *ngIf="isFieldRequired('promotionEndDate')">
                {{ getFieldError('promotionEndDate') }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Images -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>image</mat-icon>
            Images du produit
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <div class="image-upload-section">
              <div class="upload-area">
                <input type="file" 
                       #fileInput 
                       (change)="onImageSelected($event)"
                       accept="image/*"
                       multiple
                       style="display: none;">
                <button mat-raised-button 
                        type="button" 
                        color="accent"
                        (click)="triggerFileInput(fileInput)">
                  <mat-icon>add_photo_alternate</mat-icon>
                  Ajouter des images
                </button>
                <p class="upload-hint">
                  Formats acceptés : JPG, PNG, WebP (max 5MB par image)<br>
                  <strong>Au moins une image est requise</strong>
                </p>
              </div>
              
              <div class="images-preview" *ngIf="productImages.length > 0">
                <div class="image-item" *ngFor="let image of productImages; let i = index">
                  <img [src]="image.url" [alt]="image.name" class="product-image">
                  <div class="image-actions">
                    <button mat-icon-button 
                            type="button"
                            color="warn" 
                            (click)="removeImage(i)"
                            matTooltip="Supprimer l'image">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <div class="image-name">{{ image.name }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statut -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>settings</mat-icon>
            Statut
          </h3>
          <mat-divider></mat-divider>
          
          <div class="form-row">
            <mat-checkbox formControlName="isActive">
              Produit actif
            </mat-checkbox>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || !isFormValidWithImages">
            <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
            {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
            <mat-progress-spinner *ngIf="loading" 
                                  diameter="20" 
                                  mode="indeterminate">
            </mat-progress-spinner>
          </button>
          
          <button mat-button type="button" (click)="onCancel()" [disabled]="loading">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>